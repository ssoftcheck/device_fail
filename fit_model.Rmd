---
title: "R Notebook"
output:
  html_notebook: default
  html_document: default
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(xgboost)
library(foreach)
library(doSNOW)
library(iterators)
library(progress)
library(tcltk)
library(DMwR)
library(ROCR)

phi = function(a,p,cutoff=0.5) {
  po = prediction(p,a)
  perf = performance(po,measure = "phi")
  point = which.min(abs(perf@x.values[[1]]-cutoff))[1]
  return(perf@y.values[[1]][point])
}
auc = function(a,p) {
  po = prediction(p,a)
  perf = performance(po,measure = "auc")
  return(perf@y.values[[1]])
}
accuracy = function(a,p,cutoff=0.5) {
  po = prediction(p,a)
  perf = performance(po,measure = "acc")
  point = which.min(abs(perf@x.values[[1]]-cutoff))[1]
  return(perf@y.values[[1]][point])
}
sensitivity = function(a,p,cutoff=0.5) {
  po = prediction(p,a)
  perf = performance(po,measure = "sens")
  point = which.min(abs(perf@x.values[[1]]-cutoff))[1]
  return(perf@y.values[[1]][point])
}
specificity = function(a,p,cutoff=0.5) {
  po = prediction(p,a)
  perf = performance(po,measure = "spec")
  point = which.min(abs(perf@x.values[[1]]-cutoff))[1]
  return(perf@y.values[[1]][point])
}

sense.xgb = function(preds, dtrain) {
  labels = getinfo(dtrain, "label")
  val = sensitivity(labels,preds,0.5)
  return(list(metric = "sensitivity", value = val))
}

balacc.xgb = function(preds,dtrain) {
  labels = getinfo(dtrain, "label")
  sens = sensitivity(labels,preds,0.5)
  spec = specificity(labels,preds,0.5)
  val = (sens+spec)/2
  return(list(metric = "bal_acc", value = val))
}

readData = function(x,filterTime=-1) {
  # filter days to save time/space
  d=fread(x)
  d[,timestamp:=lubridate::ymd_hms(timestamp)]
  d = d[order(termination_point,timestamp)]
  if(filterTime > 0) {
    failtime = min(d[fail==1,timestamp])
    if(!is.na(failtime))
      d = d[difftime(failtime,timestamp,units="hours") < filterTime]
  }
  return(d)
}
```

```{r}
# tp.folders = grep("h\\_",list.dirs("./data/"),value=TRUE)
# for(each in tp.folders) {
#   tempds = Reduce(function(a,b) rbind(a,b,fill=TRUE),Map(readData,list.files(each,full.names = TRUE)))
#   missing = tempds[,lapply(.SD,function(x) mean(is.na(x))),.SDcols=setdiff(names(tempds),"node_id"),by=node_id]
#   fwrite(missing,paste0(each,"/",strsplit(each,"//")[[1]][2],"_missing.csv"))
#   rm(missing,tempds)
# }
```


```{r}
files = grep("/h_OCHCTP\\_(?!changepoint).+csv$",list.files("C:/device failures/failure_files",full.names=TRUE),value=TRUE,perl = TRUE)
ds = Reduce(function(a,b) rbind(a,b,fill=TRUE),Map(readData,files))
ds[,fail:=factor(fail)]
```


```{r}
nodes = ds[,unique(node_id)]
vars = c(
"BerPreFecAve",
"BerPreFecMax",
"BerPreFecMin",
"ChanOchChromaticDispersionAve",
"ChanOchChromaticDispersionMax",
"ChanOchChromaticDispersionMin",
"ChanOchLBCAve",
"ChanOchLBCMax",
"ChanOchLBCMin",
"ChanOchOptAve",
"ChanOchOptMax",
"ChanOchOptMin",
"PmType",
"PmdAve",
"PmdMax",
"PmdMin",
"Qave",
"Qmax",
"Qmin",
"SoPmdAve",
"SoPmdMax",
"SoPmdMin"
)
var.formula = as.formula(paste0("fail~",paste(vars,collapse="+")))
```

```{r}
# lag variables
interval = 4 # 1 hour
lags = 24 # 1 day
l = seq(interval,lags,interval)
for(v in vars) {
  newvars = paste0(v,"_lag",l)
  ds[,(newvars) := shift(get(v),l),by=.(node_id,termination_point)]
  var.formula = update(var.formula,paste(c("~.",newvars),collapse="+"))
  vars = union(vars,newvars)
}
```

```{r}
# make folds
set.seed(5)
ds[,fold := sample(1:10,nrow(ds),replace=TRUE)]
ds[,mean(as.integer(fail)-1),fold][order(fold)]
```


```{r}
params = expand.grid(objective="binary:logistic",subsample=c(0.5,0.7,0.9),max.depth=c(2,4,8),eta=c(0.001,0.01),min.child.weight=c(1,2,3),colsample.bytree=c(0.5,0.7,0.9),stringsAsFactors = FALSE,KEEP.OUT.ATTRS = FALSE)
params = as.data.table(params)

params2 = expand.grid(objective="binary:logistic",subsample=0.7,max.depth=2,eta=0.001,min.child.weight=1,colsample.bytree=0.8,stringsAsFactors = FALSE,KEEP.OUT.ATTRS = FALSE)
params2 = as.data.table(params2)

cl = makeCluster(4)
registerDoSNOW(cl)
# opts = list(progress=function(incr) setTkProgressBar(pb,value = incr,label=sprintf("%3.2f%%",100*incr/length(nodes))))
pb = tkProgressBar(min = 0,max=max(ds$fold),title ="Progress Fold 1",label = "0%")

perf.final = foreach(cvf = min(ds$fold):max(ds$fold),.combine="rbind",.multicombine=TRUE) %do% {
  trainset = which(ds[,fold] != cvf)
  testset = which(ds[,fold] == cvf)
  
  train = SMOTE(var.formula,data=ds[trainset,c("fail",vars),with=FALSE],perc.over = 5000,perc.under = 100)
  
  # sink(paste0("progress_",gsub("(.+)@.+","\\1",n),".txt"),append=FALSE)
  cat("Fold ",cvf,"\n")
  cat("old event rate: ",ds[trainset,mean(as.integer(fail)-1)],"\n")
  cat("new event rate: ",train[,mean(as.integer(fail)-1)],"\n")

  train = xgb.DMatrix(as.matrix(train[,vars,with=FALSE]),label = as.integer(train[,fail])-1)
  test = xgb.DMatrix(as.matrix(ds[testset,vars,with=FALSE]),label = as.integer(ds[testset,fail])-1)
  xgb.DMatrix.save(train,"train.matrix")
  xgb.DMatrix.save(test,"test.matrix")
  rm(train,test)
  
  result = foreach(pnow=iter(params,by="row"),.combine="rbind",.packages=c("xgboost","data.table","ROCR"),.multicombine=TRUE) %dopar% {
    fit = xgb.train(data=xgb.DMatrix("train.matrix"),nrounds=1000,save_period=NULL,params=as.list(pnow),verbose=0)
    test = xgb.DMatrix("test.matrix")
    perf = lapply(seq(100,1000,100),function(ntree) {
      pred = predict(fit,test,ntreelimit = ntree)
      assess = lapply(seq(0.1,0.9,0.1),function(cut) lapply(list(data.table(a=ds[testset,fail],p=pred)),function(x) {
        data.table(fold=cvf,ntree=ntree,cutoff=cut,auc=auc(x$a,x$p),phi=phi(x$a,x$p,cut),acc=accuracy(x$a,x$p,cut),sens=sensitivity(x$a,x$p,cut),spec=specificity(x$a,x$p,cut))
        })[[1]])
      return(rbindlist(assess))
    })
    return(rbindlist(perf))
  }
  file.remove(c("train.matrix","test.matrix"))
  setTkProgressBar(pb,value=cvf,title = paste("Progress Fold",cvf+1),label=sprintf("%3.2f%%",100*cvf/max(ds$fold)))
  return(result)
}
stopCluster(cl)
close(pb)
# save(perf.final,file="perf.final")
```

```{r}
perf.summary = cbind(params[rep(1:nrow(params),times=length(nodes),each=9)],perf.final)
perf.summary[,balacc:= (sens+spec)/2]
perf.summary = perf.summary[,lapply(.SD,mean),by=c(names(params),"cutoff"),.SDcols=c("auc","phi","acc","sens","spec","balacc")]
```

```{r}
prog = Reduce(c,Map(readLines,grep("progress\\_",list.files(),value = TRUE)))
prog = regmatches(prog,regexec("(.+)@.+|Train-\\w+:([\\d\\.]+)\tTest-\\w+:([\\d\\.]+)",prog,perl=TRUE))
prog = Reduce(rbind,Map(function(x) c(Node=x[2],Train=x[3],Test=x[4]),prog))
prog = as.data.table(prog)
prog[,c("Train","Test") := lapply(.SD,as.numeric),.SDcols=c("Train","Test")]
prog = prog[apply(prog,1,function(x) !all(is.na(x)))]
# extend node name
ind = which(prog$Node != "")
ind = cbind(ind,c(ind[-1]-1,nrow(prog)))
for(i in 1:nrow(ind)) {
  prog[ind[i,1]:ind[i,2],Node := prog[ind[i,1],Node]]
}
prog = prog[!(is.na(Train) & is.na(Test))]
prog[,Step:=1:.N,by=Node]
```

```{r}
png("weird_auc.png",width = 8,height = 6,units = "in",res = 200)
ggplot(melt(prog,id.vars=c("Node","Step"))) + aes(x=Step,y=value,color=variable) + geom_line(size=1.5) + facet_wrap(~Node,ncol=2) + ylab("AUC") + scale_color_discrete(name="Data")
dev.off()
```


```{r}
ggplot(melt(prog,id.vars=c("Node","Step"))) + aes(x=Step,y=value,color=variable) + geom_line(size=1.5) + facet_wrap(~Node,ncol=2) +
  ylab("LogLoss") + scale_color_discrete(name="Data")
```

